<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Spring Legal Consultancy</title>
    <!-- Use project fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Domine:wght@400;600;700&family=Lato:wght@300;400;700&display=swap">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #00204c; /* Navy Blue */
            --secondary-color: #b89b5e; /* Gold */
            --bg-color: #f0f2f5;
            --text-color: #333;
            --sidebar-width: 240px;
            --white: #ffffff;
            --danger: #dc3545;
            --success: #28a745;
            --border-color: #e6e6e6;
        }

        body { 
            font-family: 'Lato', sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; 
            padding: 0; 
            color: var(--text-color); 
            height: 100vh; 
            overflow: hidden;
        }

        h1, h2, h3, h4 { font-family: 'Domine', serif; color: var(--primary-color); }

        /* Login Screen */
        #login-screen {
            display: flex; justify-content: center; align-items: center; height: 100vh; 
            background: linear-gradient(135deg, var(--primary-color) 0%, #001533 100%);
        }
        .login-box {
            background: var(--white); padding: 50px; border-radius: 8px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-box img { max-height: 60px; margin-bottom: 20px; }
        .login-box input {
            width: 100%; padding: 15px; margin-bottom: 20px; border: 1px solid #ddd; 
            border-radius: 4px; box-sizing: border-box; font-size: 16px;
        }
        .btn {
            padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; 
            font-weight: 700; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px;
            font-size: 14px;
        }
        .btn-primary { background: var(--secondary-color); color: var(--white); }
        .btn-primary:hover { background: #a0854d; transform: translateY(-2px); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-outline { background: transparent; border: 1px solid #ddd; color: var(--text-color); }
        .btn-outline:hover { background: #eee; }

        .error-msg { color: var(--danger); margin-top: 10px; font-size: 14px; display: none; }

        /* Email Client Layout */
        #dashboard { display: none; height: 100vh; width: 100%; }
        .email-container { display: flex; height: 100%; width: 100%; }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width); 
            background: var(--primary-color); 
            color: rgba(255,255,255,0.8);
            display: flex; 
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header h2 { color: var(--white); font-size: 18px; margin: 0; letter-spacing: 1px; font-weight: 700; }
        
        .compose-btn-container { padding: 20px; }
        .compose-btn {
            background: var(--secondary-color); color: white; width: 100%; padding: 12px;
            border-radius: 4px; border: none; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s;
        }
        .compose-btn:hover { background: #a0854d; }

        .folders { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .folder-item {
            padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s; font-size: 15px;
        }
        .folder-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .folder-item.active { background: rgba(255,255,255,0.1); color: white; border-left: 4px solid var(--secondary-color); padding-left: 16px; }
        .folder-item i { width: 20px; margin-right: 10px; }
        .badge-count { 
            background: var(--secondary-color); color: white; font-size: 11px; 
            padding: 2px 8px; border-radius: 10px; font-weight: 700;
        }
        .badge-count.hidden { display: none; }

        .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }

        /* Main Content */
        .main-area { flex-grow: 1; display: flex; flex-direction: column; background: white; overflow: hidden; }
        
        /* Top Search Bar */
        .top-bar {
            height: 64px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center;
            padding: 0 20px; background: white; flex-shrink: 0;
        }
        .search-wrapper {
            flex-grow: 1; max-width: 600px; position: relative;
        }
        .search-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }
        .search-input {
            width: 100%; padding: 10px 10px 10px 40px; border-radius: 4px; border: 1px solid #ddd;
            background: #f5f5f5; font-family: 'Lato', sans-serif; font-size: 15px;
        }
        .search-input:focus { background: white; border-color: var(--secondary-color); outline: none; }

        /* Toolbar */
        .toolbar {
            padding: 10px 20px; border-bottom: 1px solid var(--border-color); background: #fcfcfc;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .toolbar-actions button {
            background: none; border: 1px solid #ddd; padding: 6px 12px; border-radius: 4px;
            cursor: pointer; color: #555; margin-right: 5px; font-size: 14px;
        }
        .toolbar-actions button:hover { background: #eee; color: var(--primary-color); }

        /* Email List */
        .email-list { flex-grow: 1; overflow-y: auto; }
        .email-row {
            display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid var(--border-color);
            cursor: pointer; transition: background 0.1s;
        }
        .email-row:hover { background: #f2f6fc; box-shadow: inset 3px 0 0 var(--secondary-color); }
        
        /* Unread State */
        .email-row.unread { background: white; }
        .email-row.unread .sender, .email-row.unread .subject { font-weight: 700; color: var(--primary-color); }
        .email-row.read { background: #f8f9fa; color: #666; }
        
        .col-check { width: 30px; flex-shrink: 0; }
        .col-star { width: 30px; flex-shrink: 0; color: #ddd; }
        .col-star.active { color: var(--secondary-color); }
        .col-sender { width: 200px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .col-subject { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 20px; }
        .col-date { width: 100px; flex-shrink: 0; text-align: right; font-size: 13px; color: #888; }
        
        .status-dot {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px;
        }
        .dot-new { background: var(--secondary-color); }
        .dot-replied { background: var(--success); }
        .dot-read { border: 1px solid #ccc; }

        /* Modals */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: var(--white); padding: 40px; border-radius: 8px; width: 90%; max-width: 700px;
            position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .close-modal {
            position: absolute; top: 20px; right: 25px; font-size: 24px; cursor: pointer; color: #aaa;
        }
        .close-modal:hover { color: var(--danger); }
        
        .message-meta { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .message-meta p { margin: 8px 0; color: #555; }
        .message-meta strong { color: var(--primary-color); width: 60px; display: inline-block; }
        
        /* Thread Styles */
        .thread-container { display: flex; flex-direction: column; gap: 20px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .thread-item { padding: 20px; border-radius: 8px; border: 1px solid #eee; position: relative; }
        .thread-item.original { background: #fcfcfc; border-left: 4px solid var(--secondary-color); }
        .thread-item.reply { background: #eef2f6; border-left: 4px solid var(--primary-color); margin-left: 30px; }
        .thread-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; color: #888; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 8px; }
        .thread-body { line-height: 1.6; color: #333; white-space: pre-wrap; font-size: 15px; }
        
        .modal-actions { margin-top: 30px; display: flex; gap: 15px; justify-content: flex-end; }

        /* Reply Form */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color); }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;
            font-family: 'Lato', sans-serif; font-size: 15px;
        }
        .form-control:focus { border-color: var(--secondary-color); outline: none; }
        textarea.form-control { resize: vertical; min-height: 150px; }

        .empty-state {
            text-align: center; padding: 50px; color: #999;
        }
        .empty-state i { font-size: 48px; margin-bottom: 20px; opacity: 0.5; }

        /* Toast */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 4px; padding: 16px; position: fixed; z-index: 1001; left: 50%; bottom: 30px;
            transform: translateX(-50%); font-size: 15px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-box">
            <h2 style="margin-bottom: 5px;">Admin Login</h2>
            <p style="color: #888; margin-bottom: 30px;">Spring Legal Consultancy</p>
            <form id="login-form">
                <input type="password" id="password" placeholder="Enter Admin Password" required>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login to Dashboard</button>
                <p class="error-msg" id="login-error">Invalid password</p>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
        <div class="email-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2><i class="fas fa-balance-scale"></i> SLC ADMIN</h2>
                </div>
                
                <div class="compose-btn-container">
                    <button class="compose-btn" onclick="alert('This is an inbox for client inquiries. You can reply to messages from the list.')">
                        <i class="fas fa-pen"></i> Compose
                    </button>
                </div>

                <ul class="folders">
                    <li class="folder-item active" onclick="filterContacts('new', this)">
                        <span><i class="fas fa-inbox"></i> Inbox</span>
                        <span class="badge-count" id="count-new">0</span>
                    </li>
                    <li class="folder-item" onclick="filterContacts('read', this)">
                        <span><i class="fas fa-envelope-open"></i> Read</span>
                        <span class="badge-count hidden" id="count-read">0</span>
                    </li>
                    <li class="folder-item" onclick="filterContacts('replied', this)">
                        <span><i class="fas fa-reply"></i> Replied</span>
                        <span class="badge-count hidden" id="count-replied">0</span>
                    </li>
                    <li class="folder-item" onclick="filterContacts('all', this)">
                        <span><i class="fas fa-archive"></i> All Mail</span>
                        <span class="badge-count" id="count-all">0</span>
                    </li>
                    <li class="folder-item" onclick="alert('Trash feature coming soon')">
                        <span><i class="fas fa-trash-alt"></i> Trash</span>
                    </li>
                </ul>

                <div class="sidebar-footer">
                    <button class="btn btn-outline" onclick="logout()" style="width: 100%; color: white; border-color: rgba(255,255,255,0.3);">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Main Area -->
            <div class="main-area">
                <div class="top-bar">
                    <div class="search-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" class="search-input" id="search-input" placeholder="Search messages by name, subject or email...">
                    </div>
                </div>

                <div class="toolbar">
                    <div class="toolbar-actions">
                        <button onclick="fetchContacts()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                        <button onclick="alert('Select items to delete')" title="Delete"><i class="fas fa-trash"></i></button>
                        <button onclick="alert('Select items to mark as read')" title="Mark as Read"><i class="fas fa-envelope-open"></i></button>
                    </div>
                    <div style="font-size: 13px; color: #666;">
                        Showing <span id="showing-count">0</span> messages
                    </div>
                </div>

                <div class="email-list" id="email-list">
                    <!-- Email rows will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- View Message Modal -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('message-modal')">&times;</span>
            <h2 id="modal-subject" style="margin-top: 0;">Subject</h2>
            <div style="margin-bottom: 15px;">
                <span id="modal-status-badge" class="badge-count" style="background: #ccc;">Status</span>
            </div>
            <div class="message-meta">
                <p><strong>From:</strong> <span id="modal-name"></span> &lt;<span id="modal-email"></span>&gt;</p>
                <p><strong>Phone:</strong> <span id="modal-phone"></span></p>
                <p><strong>Date:</strong> <span id="modal-date"></span></p>
            </div>
            <div id="thread-container" class="thread-container"></div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="updateStatus('read')">Mark Read</button>
                <button class="btn btn-primary" onclick="openReplyModal()">
                    <i class="fas fa-reply"></i> Reply
                </button>
                <button class="btn btn-danger" onclick="deleteContact(currentContact.id)" style="margin-left: auto;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Reply Modal -->
    <div id="reply-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('reply-modal')">&times;</span>
            <h2 style="margin-top: 0; margin-bottom: 20px;">Compose Reply</h2>
            <form id="reply-form">
                <input type="hidden" id="reply-id">
                <div class="form-group">
                    <label>To:</label>
                    <input type="email" id="reply-to" class="form-control" readonly style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label>Subject:</label>
                    <input type="text" id="reply-subject" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Message:</label>
                    <textarea id="reply-message" class="form-control" placeholder="Type your reply here..." required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('reply-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send Reply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        const API_URL = '/api/v1/admin';
        let allContacts = [];
        let filteredContacts = [];
        let currentContact = null;
        let currentFilter = 'new'; // Default to Inbox (Unread)

        // Check if logged in on load
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('adminToken');
            if (token) {
                showDashboard();
            }
        });

        // Login Logic
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');

            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();

                if (data.success) {
                    localStorage.setItem('adminToken', data.token);
                    showDashboard();
                } else {
                    errorMsg.style.display = 'block';
                }
            } catch (err) {
                console.error(err);
                errorMsg.textContent = 'Connection error';
                errorMsg.style.display = 'block';
            }
        });

        function logout() {
            localStorage.removeItem('adminToken');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('password').value = '';
        }

        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            fetchContacts();
        }

        async function fetchContacts() {
            const token = localStorage.getItem('adminToken');
            try {
                const res = await fetch(`${API_URL}/contacts`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.status === 401 || res.status === 403) {
                    logout();
                    return;
                }

                allContacts = await res.json();
                updateCounts();
                applyFilter();
            } catch (err) {
                console.error('Error fetching contacts:', err);
            }
        }

        function updateCounts() {
            const newCount = allContacts.filter(c => !c.status || c.status === 'new').length;
            const readCount = allContacts.filter(c => c.status === 'read').length;
            const repliedCount = allContacts.filter(c => c.status === 'replied').length;
            
            document.getElementById('count-new').textContent = newCount;
            document.getElementById('count-read').textContent = readCount;
            document.getElementById('count-replied').textContent = repliedCount;
            document.getElementById('count-all').textContent = allContacts.length;
        }

        function filterContacts(filterType, element) {
            currentFilter = filterType;
            
            // Update sidebar active state
            if (element) {
                document.querySelectorAll('.folder-item').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
            }

            applyFilter();
        }

        function applyFilter() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            filteredContacts = allContacts.filter(contact => {
                // Filter by folder type
                let matchesType = false;
                const status = contact.status || 'new';
                
                if (currentFilter === 'all') matchesType = true;
                else if (currentFilter === 'new') matchesType = (status === 'new');
                else if (currentFilter === 'read') matchesType = (status === 'read');
                else if (currentFilter === 'replied') matchesType = (status === 'replied');

                // Filter by search
                const matchesSearch = 
                    contact.name.toLowerCase().includes(searchTerm) ||
                    contact.subject.toLowerCase().includes(searchTerm) ||
                    contact.email.toLowerCase().includes(searchTerm);

                return matchesType && matchesSearch;
            });

            renderList();
        }

        // Search listener
        document.getElementById('search-input').addEventListener('keyup', applyFilter);

        function renderList() {
            const listContainer = document.getElementById('email-list');
            const countSpan = document.getElementById('showing-count');
            
            listContainer.innerHTML = '';
            countSpan.textContent = filteredContacts.length;

            if (filteredContacts.length === 0) {
                listContainer.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No messages found</p></div>';
                return;
            }

            filteredContacts.forEach(contact => {
                const date = new Date(contact.created_at).toLocaleDateString('en-GB', {
                    day: 'numeric', month: 'short', year: 'numeric'
                });
                const status = contact.status || 'new';
                const isUnread = status === 'new';
                const rowClass = isUnread ? 'unread' : 'read';
                
                let statusDotClass = 'dot-read';
                if (status === 'new') statusDotClass = 'dot-new';
                if (status === 'replied') statusDotClass = 'dot-replied';
                
                const replyIcon = status === 'replied' ? '<i class="fas fa-reply" style="color: var(--success); margin-right: 5px;" title="Replied"></i>' : '';
                
                const div = document.createElement('div');
                div.className = `email-row ${rowClass}`;
                div.onclick = () => viewMessage(contact.id);
                div.innerHTML = `
                    <div class="col-check"><input type="checkbox" onclick="event.stopPropagation()"></div>
                    <div class="col-star"><i class="far fa-star"></i></div>
                    <div class="col-sender">
                        <span class="status-dot ${statusDotClass}"></span>
                        ${contact.name}
                    </div>
                    <div class="col-subject">
                        ${replyIcon}${contact.subject} <span style="color: #999; font-weight: 400;">- ${contact.message.substring(0, 50)}...</span>
                    </div>
                    <div class="col-date">${date}</div>
                `;
                listContainer.appendChild(div);
            });
        }

        async function viewMessage(id) {
            const token = localStorage.getItem('adminToken');
            
            // Show modal immediately with loading state
            document.getElementById('message-modal').style.display = 'flex';
            document.getElementById('thread-container').innerHTML = '<p style="text-align:center; padding: 20px;">Loading conversation...</p>';

            try {
                // Add timestamp to prevent caching
                const res = await fetch(`${API_URL}/contacts/${id}/history?t=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (!data.contact) return;

                const contact = data.contact;
                const replies = data.replies || [];
                currentContact = contact;

                // Update Header Info
                document.getElementById('modal-subject').textContent = contact.subject;
                document.getElementById('modal-name').textContent = contact.name;
                document.getElementById('modal-email').textContent = contact.email;
                document.getElementById('modal-phone').textContent = contact.phone || 'N/A';
                document.getElementById('modal-date').textContent = new Date(contact.created_at).toLocaleString();
                
                const status = contact.status || 'new';
                const badge = document.getElementById('modal-status-badge');
                badge.textContent = status.toUpperCase();
                badge.style.background = status === 'new' ? 'var(--secondary-color)' : (status === 'replied' ? 'var(--success)' : '#ccc');

                // Build Thread HTML
                let html = `
                    <div class="thread-item original">
                        <div class="thread-header">
                            <span><strong>${contact.name}</strong> wrote:</span>
                            <span>${new Date(contact.created_at).toLocaleString()}</span>
                        </div>
                        <div class="thread-body">${contact.message}</div>
                    </div>
                `;

                replies.forEach(reply => {
                    html += `
                        <div class="thread-item reply">
                            <div class="thread-header">
                                <span><i class="fas fa-reply"></i> <strong>Admin</strong> replied:</span>
                                <span>${new Date(reply.created_at).toLocaleString()}</span>
                            </div>
                            <div class="thread-body">${reply.message}</div>
                        </div>
                    `;
                });

                const container = document.getElementById('thread-container');
                container.innerHTML = html;
                container.scrollTop = container.scrollHeight; // Scroll to bottom

            } catch (err) {
                console.error(err);
                document.getElementById('thread-container').innerHTML = '<p style="color:red; text-align:center;">Failed to load message history.</p>';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function updateStatus(status) {
            if (!currentContact) return;
            const token = localStorage.getItem('adminToken');

            try {
                await fetch(`${API_URL}/contacts/${currentContact.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status })
                });
                
                showToast(`Marked as ${status}`);
                closeModal('message-modal');
                fetchContacts();
            } catch (err) {
                console.error('Error updating status:', err);
            }
        }

        async function deleteContact(id) {
            if (!confirm('Are you sure you want to delete this message?')) return;
            
            const token = localStorage.getItem('adminToken');
            try {
                await fetch(`${API_URL}/contacts/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                closeModal('message-modal');
                fetchContacts();
                showToast('Message deleted');
            } catch (err) {
                console.error('Error deleting contact:', err);
            }
        }

        // --- Reply Functionality ---

        function openReplyModal() {
            if (!currentContact) return;

            // Close view modal if open
            document.getElementById('message-modal').style.display = 'none';

            // Populate reply form
            document.getElementById('reply-id').value = currentContact.id;
            document.getElementById('reply-to').value = currentContact.email;
            document.getElementById('reply-subject').value = `Re: ${currentContact.subject}`;
            document.getElementById('reply-message').value = `Dear ${currentContact.name},\n\nThank you for contacting Spring Legal Consultancy.\n\n`;

            document.getElementById('reply-modal').style.display = 'flex';
        }

        document.getElementById('reply-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('adminToken');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            const payload = {
                id: document.getElementById('reply-id').value,
                email: document.getElementById('reply-to').value,
                subject: document.getElementById('reply-subject').value,
                message: document.getElementById('reply-message').value
            };

            try {
                const res = await fetch(`${API_URL}/reply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success) {
                    showToast('Reply sent successfully!');
                    closeModal('reply-modal');
                    fetchContacts(); // Refresh to show updated status
                } else {
                    alert('Error: ' + (data.error || 'Failed to send'));
                }
            } catch (err) {
                console.error(err);
                alert('Failed to send reply. Check console.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.className = "show";
            toast.textContent = message;
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // Close modal if clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
